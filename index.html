<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="imgs/logo.png" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Вход | Chocolate Eye</title>
    <link rel="stylesheet" href="static/style.css" />

    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #111;
        color: #eee;
        margin: 0;
        font-family: sans-serif;
      }

      .card {
        background: #1b1b1b;
        padding: 30px;
        height: 320px;
        border-radius: 20px;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        text-align: center;
        width: 320px;
      }

      a.btn {
        display: block;
        text-align: center;
        width: 100%;
        margin-top: 20px;
        padding: 12px;
        border-radius: 10px;
        background: #a45c3d;
        color: white;
        font-weight: bold;
        text-decoration: none;
        transition: 0.2s;
      }

      a.btn:hover {
        background: #c4704a;
      }

      #loader {
        width: 100px;
        height: 100px;
        margin: 30px auto;
      }

      .hidden {
        display: none !important;
      }

      .block {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #111111b4;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #loader{
        padding: 10px;

        border-radius: 15px;

        background-color: #111;

        box-shadow: 0 0 15px rgba(58, 58, 58, 0.1);
      }
    </style>
  </head>

  <body>
    <div id="overlay" class="hidden block">
    
      <div id="loader"></div>
    </div>

    <div class="card">
      <div>
        <img
          class="userSelect"
          draggable="false"
          src="imgs/logo.png"
          width="120px"
          alt="logo"
        />
        <h2>Вход через Telegram</h2>
      </div>

      <a
        href="https://t.me/chocolateCodes_bot?start=login"
        class="btn"
        target="_blank"
        >Войти через Telegram</a
      >
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script>
      const API = "https://chocolateeyeserver-production.up.railway.app/api";
      // const API = "http://127.0.0.1:3000/api";

      const overlay = document.getElementById("overlay");
      const loaderContainer = document.getElementById("loader");

      const loader = lottie.loadAnimation({
        container: loaderContainer,
        renderer: "svg",
        loop: true,
        autoplay: false,
        path: "imgs/loader.json",
      });

      function showLoader() {
        overlay.classList.remove("hidden");
        loader.play();
      }

      function hideLoader() {
        overlay.classList.add("hidden");
        loader.stop();
      }

      // Проверка токена при загрузке страницы
      async function checkExistingSession() {
        const token = localStorage.getItem("session");
        if (!token) await handleTempToken();
        
        try {
          const res = await fetch(`${API}/me`, {
            headers: { "x-session": token },
          });

          if (!res.ok) await handleTempToken();

          const data = await res.json();
          if (data && data.email) {
            // токен валиден
            location.href = "static/main.html";
            return
          }
        } catch (e) {
          console.warn("Ошибка проверки токена:", e);
        }
      }

      async function handleTempToken() {
        const params = new URLSearchParams(window.location.search);
        const temp = params.get("code");
        if (!temp) return;

        showLoader();

        try {
          const res = await fetch(`${API}/confirm-temp-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ temp_token: temp }),
          });

          const data = await res.json();
          hideLoader();

          if (data.token) {
            localStorage.setItem("session", data.token);
            location.href = "static/main.html";
          } else {
            alert(data.error || "Ошибка авторизации");
          }
        } catch (err) {
          hideLoader();
          alert("Ошибка соединения с сервером");
          console.error(err);
        }
      }

      (async () => {
        await checkExistingSession();
      })();
    </script>
  </body>
</html>