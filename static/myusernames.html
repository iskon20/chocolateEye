<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="../imgs/logo.png" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Сохранённые | Chocolate Eye</title>
    <link rel="stylesheet" href="style.css" />

    <style>
      button.action {
        margin: 0 3px;
        padding: 1vw 2vw;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 13px;
      }

      button.delete {
        background: #ff4d4d;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <img class="logo" width="20%" src="../imgs/logo.png" alt="" />
      <h2>Сохранённые карточки</h2>
      <button onclick="back()">Назад</button>
    </div>

    <table id="list" class="responsive-table">
      <thead>
        <tr>
          <th>Юзер</th>
          <th>Ссылка на тг</th>
          <th>ID</th>
          <th>Чат</th>
          <th class="status_hidden hidden">Статус</th>
          <th class="status_hidden hidden">Телефон</th>
          <th class="status_hidden hidden">Продажа</th>
          <th>Страна</th>
          <th>Добавлен</th>
          <th>Действие</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <script>
      // const API = "https://chocolateeyeserver-production.up.railway.app/api";
      const API = "http://127.0.0.1:3000/api";

      const token = localStorage.getItem("session");

      function countryFlag(code) {
        if (!code) return "";
        code = code.trim().toLowerCase();
        return `<img src="../imgs/flags/${code}.png" width="24" height="16">`;
      }

      document.addEventListener("click", async (e) => {
        const el = e.target.closest(".copyable");
        if (!el) return;

        let text = el.innerText.trim();
        if (el.dataset.label === "ID") {
          text = text.replace(/\s|&nbsp;|\u00A0/g, "");
        }

        try {
          await navigator.clipboard.writeText(text);
          el.classList.add("copied");
          setTimeout(() => el.classList.remove("copied"), 800);
        } catch {}
      });

      const loader = document.createElement("div");
      loader.id = "loader";
      loader.className = "loader";
      loader.style.width = "120px";
      loader.style.margin = "30px auto";

      async function load() {
        const tbody = document.querySelector("#list tbody");
        tbody.innerHTML = "";
        tbody.parentElement.after(loader);

        const anim = lottie.loadAnimation({
          container: loader,
          renderer: "svg",
          loop: true,
          autoplay: true,
          path: "../imgs/loader.json",
        });

        try {
          anim.destroy();
          loader.remove();

          const res = await fetch(`${API}/saved`, {
            headers: { "x-session": token },
          });

          const result = await res.json();
          const data = result.data;

          if (!Array.isArray(data) || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td colspan="10" style="text-align:center; justify-content: center; padding:20px; color:#888;">
            Ничего не найдено
            </td>`;
            tbody.appendChild(tr);
            return;
          }

          data.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td class="copyable" data-label="Юзер">${r.username || "-"}</td>
            <td data-label="Ссылка на ТГ">
      ${
        r.username
          ? `
        <a class="tg-link" href="https://t.me/${r.username}" target="_blank" rel="noopener noreferrer">
            <img class="tg-icon" src="../imgs/telegram.svg" alt="Telegram">
          <span class="tg-text">@${r.username}</span>
        </a>
      `
          : ""
      }
    </td>
              <td class="copyable" data-label="ID">
                ${r.uid.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "&nbsp;")}
              </td>
              <td class="copyable" data-label="Чат">${r.found_from || "-"}</td>

              <td class="${
                window.isCleared ? "hidden" : ""
              }" data-label="Статус">
                ${r.status || "-"}
              </td>

              <td class="copyable ${
                window.isCleared ? "hidden" : ""
              }" data-label="Телефон">
                ${r.number ? `+${r.number}` : "-"}
              </td>

              <td class="${
                window.isCleared ? "hidden" : ""
              }" data-label="Продажа">
                ${r.on_sale ? "✅" : "❌"}
              </td>

              <td data-label="Страна">${countryFlag(r.country)}</td>

              <td data-label="Добавлен">
                ${r.saved_at?.replace("T", " ").slice(0, 19) || "-"}
              </td>

              <td data-label="Действие">
                <button class="action delete" onclick="unsave(${r.uid})">
                  Удалить
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error(e);
          loader.textContent = "Ошибка загрузки";
        }
      }

      async function unsave(id) {
        if (!confirm("Удалить из сохранённых?")) return;

        const res = await fetch(`${API}/usernames/save/${id}`, {
          method: "POST",
          headers: { "x-session": token },
        });

        const data = await res.json();
        if (data.ok) load();
        else alert("Ошибка");
      }

      function back() {
        location.href = "usernames.html";
      }

      async function checkAdmin() {
        if (!token) return;

        try {
          const res = await fetch(`${API}/me`, {
            headers: { "x-session": token },
          });
          const data = await res.json();

          if (!data.cleared) {
            document
              .querySelectorAll(".status_hidden.hidden")
              .forEach((el) => el.classList.remove("hidden"));
          }

          window.isCleared = data.cleared;
        } catch (e) {
          console.error("Admin check error:", e);
        }
      }

      checkAdmin();
      load();
    </script>
  </body>
</html>
